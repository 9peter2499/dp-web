<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>แก้ไข TOR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
      body {
        font-family: "Sarabun", sans-serif;
        font-size: 16px;
      }
      .ql-editor {
        min-height: 10rem;
        background-color: white;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-4 sm:p-8">
    <div id="loading" class="text-center text-lg text-gray-600">
      กำลังโหลดข้อมูล...
    </div>

    <div id="content" class="hidden max-w-5xl mx-auto space-y-6">
      <div>
        <h1
          id="page-title"
          class="text-2xl font-bold text-gray-800 break-words"
          style="text-align: center"
        ></h1>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label
              for="tor_status"
              class="block text-base font-bold text-gray-800 mb-2"
              >สถานะ</label
            >
            <select
              id="tor_status"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-base focus:ring-indigo-500 focus:border-indigo-500"
              style="color: blue"
            >
              <option value="ผ่าน">ผ่าน</option>
              <option value="ไม่ผ่าน">ไม่ผ่าน</option>
            </select>
          </div>
          <div>
            <label
              for="tor_fixing"
              class="block text-base font-bold text-gray-800 mb-2"
              >การแก้ไข</label
            >
            <select
              id="tor_fixing"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-base focus:ring-indigo-500 focus:border-indigo-500"
              style="color: blue"
            >
              <option value=""></option>
              <option value="แก้ไขแล้ว">แก้ไขแล้ว</option>
              <option value="แก้ไขแล้วรอการพิจารณา">
                แก้ไขแล้วรอการพิจารณา
              </option>
              <option value="ต้องการคำแนะนำจากคณะกรรมการเพิ่มเติม">
                ต้องการคำแนะนำจากคณะกรรมการเพิ่มเติม
              </option>
            </select>
          </div>
          <div>
            <label
              for="tord_posible"
              class="block text-base font-bold text-gray-800 mb-2"
              >ทำได้</label
            >
            <select
              id="tord_posible"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-base focus:ring-indigo-500 focus:border-indigo-500"
              style="color: blue"
            >
              <option>ฟังก์ชันมาตรฐาน</option>
              <option>พัฒนาเพิ่มเติม</option>
            </select>
          </div>
        </div>
        <hr />
        <div>
          <label class="block text-base font-bold text-gray-800 mb-2"
            >เล่มเอกสาร</label
          >
          <div
            id="doc-book-editor"
            class="mt-1 bg-white border border-gray-300 rounded-md"
          ></div>
        </div>

        <div>
          <label class="block text-base font-bold text-gray-800 mb-2"
            >เอกสารอ้างอิง</label
          >
          <div
            id="ref-editor"
            class="mt-1 bg-white border border-gray-300 rounded-md"
          ></div>
        </div>

        <div>
          <label class="block text-base font-bold text-gray-800 mb-2"
            >หัวข้อที่นำเสนอ</label
          >
          <div
            id="header-editor"
            class="mt-1 bg-white border border-gray-300 rounded-md"
          ></div>
        </div>

        <div>
          <label class="block text-base font-bold text-gray-800 mb-2"
            >Prototype</label
          >
          <div
            id="prototype-editor"
            class="mt-1 bg-white border border-gray-300 rounded-md"
          ></div>
        </div>
      </div>

      <div class="flex justify-end gap-4 pt-4">
        <a
          href="/tors.html"
          id="back-btn"
          class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400"
          >กลับหน้ารายการ</a
        >
        <button
          id="save-btn"
          class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700"
        >
          บันทึกการเปลี่ยนแปลง
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://fhnprrlmlhleomfqqvpp.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobnBycmxtbGhsZW9tZnFxdnBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTAyMjIsImV4cCI6MjA2NjQ4NjIyMn0.WA-_yNFWxpFnJBA3oh5UlOtq89KBm5hqsb51oi04hMk"; // ตัดเพื่อความปลอดภัย

      const { createClient } = supabase;
      const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const pageTitle = document.getElementById("page-title");
      const torStatusSelect = document.getElementById("tor_status");
      const torFixingSelect = document.getElementById("tor_fixing");
      const tordPosibleSelect = document.getElementById("tord_posible");
      const saveButton = document.getElementById("save-btn");
      const backButton = document.getElementById("back-btn");
      const loadingDiv = document.getElementById("loading");
      const contentDiv = document.getElementById("content");

      let docBookEditor, refEditor, headerEditor, prototypeEditor;

      document.addEventListener("DOMContentLoaded", async () => {
        const editorOptions = { modules: { toolbar: true }, theme: "snow" };
        docBookEditor = new Quill("#doc-book-editor", editorOptions);
        refEditor = new Quill("#ref-editor", editorOptions);
        headerEditor = new Quill("#header-editor", editorOptions);
        prototypeEditor = new Quill("#prototype-editor", editorOptions);

        const {
          data: { session },
        } = await _supabase.auth.getSession();
        if (session) {
          await checkRoleAndLoadData(session);
        } else {
          window.location.href = "/login.html";
        }
      });

      async function checkRoleAndLoadData(session) {
        try {
          const { data: profile } = await _supabase
            .from("profiles")
            .select("role")
            .eq("id", session.user.id)
            .single();

          if (!profile || profile.role !== "admin") {
            alert("คุณไม่มีสิทธิ์เข้าถึงหน้านี้");
            window.location.href = "/tors.html";
            return;
          }

          const params = new URLSearchParams(window.location.search);
          const torId = params.get("id");
          if (!torId) throw new Error("ไม่พบ TOR ID ใน URL");

          await loadData(torId);

          saveButton.onclick = () => saveData(torId);
          backButton.href = `/tors.html#${torId}`;
        } catch (error) {
          loadingDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
          loadingDiv.classList.remove("hidden");
          contentDiv.classList.add("hidden");
        }
      }

      const loadMasterOptions = async (group) => {
        const res = await fetch(
          `https://pcsdata.onrender.com/api/options?group=${group}`
        );
        if (!res.ok) {
          throw new Error(`โหลด MasterOptions ไม่สำเร็จ (${group})`);
        }
        const options = await res.json();
        return options;
      };

      function populateSelect(selectEl, options, selectedValue) {
        if (!Array.isArray(options)) {
          console.warn("populateSelect ได้ options ที่ไม่ใช่ array:", options);
          return;
        }

        selectEl.innerHTML = `<option value="">-- กรุณาเลือก --</option>`;
        options.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.option_id;
          option.textContent = opt.option_label;
          if (opt.option_id === selectedValue) {
            option.selected = true;
          }
          selectEl.appendChild(option);
        });
      }

      async function loadData(torId) {
        try {
          // โหลดข้อมูลจาก API
          const response = await fetch(
            `https://pcsdata.onrender.com/api/tors/${torId}`
          );
          if (!response.ok) throw new Error("ไม่สามารถดึงข้อมูล TOR ได้");
          const data = await response.json();

          // โหลด MasterOptions ทั้งหมด
          const [statusOpts, fixingOpts, posibleOpts] = await Promise.all([
            loadMasterOptions("status"),
            loadMasterOptions("fixing"),
            loadMasterOptions("posible"),
          ]);

          // Populate dropdown
          populateSelect(torStatusSelect, statusOpts || [], data.tor_status_id);
          populateSelect(torFixingSelect, fixingOpts || [], data.tor_fixing_id);
          const detail = data.TORDetail[0] || {};

          populateSelect(
            tordPosibleSelect,
            posibleOpts || [],
            detail.tord_posible_id
          );

          // Set text content
          pageTitle.textContent = `แก้ไข TOR: ${data.tor_name}`;
          docBookEditor.root.innerHTML = detail.tord_document || "";
          refEditor.root.innerHTML = detail.tord_reference || "";
          headerEditor.root.innerHTML = detail.tord_header || "";
          prototypeEditor.root.innerHTML = detail.tord_prototype || "";

          loadingDiv.classList.add("hidden");
          contentDiv.classList.remove("hidden");
        } catch (error) {
          loadingDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
        }
      }

      async function saveData(torId) {
        const {
          data: { session },
        } = await _supabase.auth.getSession();

        const torData = {
          tor_status_id: torStatusSelect.value,
          tor_fixing_id: torFixingSelect.value,
        };

        const tordId = `D${torId.substring(1)}`;
        const torDetailData = {
          tord_posible_id: tordPosibleSelect.value,
          tord_document: docBookEditor.root.innerHTML,
          tord_reference: refEditor.root.innerHTML,
          tord_header: headerEditor.root.innerHTML,
          tord_prototype: prototypeEditor.root.innerHTML,
        };

        try {
          const torRes = await fetch(
            `https://pcsdata.onrender.com/api/tors/${torId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${session.access_token}`,
              },
              body: JSON.stringify(torData),
            }
          );
          if (!torRes.ok) throw new Error("เกิดข้อผิดพลาดในการบันทึก TORs");

          const detailRes = await fetch(
            `https://pcsdata.onrender.com/api/tordetail/${tordId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${session.access_token}`,
              },
              body: JSON.stringify(torDetailData),
            }
          );
          if (!detailRes.ok)
            throw new Error("เกิดข้อผิดพลาดในการบันทึก TORDetail");

          alert("บันทึกการเปลี่ยนแปลงสำเร็จ!");
          window.location.href = `/tors.html#${torId}`;
        } catch (error) {
          alert(`เกิดข้อผิดพลาด: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
