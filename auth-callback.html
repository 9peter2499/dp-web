<!DOCTYPE html>
<html>
<head>
    <title>Authenticating...</title>
</head>
<body>
    <p>กำลังตรวจสอบสถานะการล็อคอิน, กรุณารอสักครู่...</p>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fhnprrlmlhleomfqqvpp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobnBycmxtbGhsZW9tZnFxdnBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTAyMjIsImV4cCI6MjA2NjQ4NjIyMn0.WA-_yNFWxpFnJBA3oh5UlOtq89KBm5hqsb51oi04hMk';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // รอฟังสัญญาณจาก Supabase
        _supabase.auth.onAuthStateChange(async (event, session) => {
            // เราจะทำงานก็ต่อเมื่อมี event SIGNED_IN และมี session จริงๆ เท่านั้น
            if (event === 'SIGNED_IN' && session) {
                
                // (Optional) เพิ่มการบันทึก Log การ Login
                try {
                    await fetch('http://localhost:3000/api/log-action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: session.user.id,
                            action: 'LOGIN_SUCCESS'
                        })
                    });
                } catch(e) {
                    console.error("Failed to log login action:", e);
                }

                // Redirect ไปที่หน้าหลัก
                window.location.href = '/tors.html';
            }
        });
    </script>
</body>
</html>