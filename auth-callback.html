<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Authenticating...</title>
</head>
<body class="p-8">
  <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>

  <script type="module">
    import { createClient } 
      from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/+esm';

    // --- 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° client ---
    const SUPABASE_URL      = 'https://fhnprrlmlhleomfqqvpp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobnBycmxtbGhsZW9tZnFxdnBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTAyMjIsImV4cCI6MjA2NjQ4NjIyMn0.WA-_yNFWxpFnJBA3oh5UlOtq89KBm5hqsb51oi04hMk';
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // expose client ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡πÉ‡∏ô console ‡πÑ‡∏î‡πâ
    window.supabaseClient = supabaseClient;

    // ‡∏î‡∏π URL ‡πÅ‡∏•‡∏∞ fragment ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ
    console.log('üîç Auth callback URL:', window.location.href);
    console.log('üîç Hash fragment:', window.location.hash);

    try {
      let session;

      // --- 2. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á session ‡∏à‡∏≤‡∏Å URL fragment ---
      const { data: urlData, error: urlErr } = 
        await supabaseClient.auth.getSessionFromUrl({ storeSession: true });
      console.log('‚úÖ getSessionFromUrl ‚Üí', urlData, urlErr);
      if (urlData?.session) {
        session = urlData.session;
      } else {
        // --- 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å storage ---
        const { data: storedData, error: storedErr } = await supabaseClient.auth.getSession();
        console.log('‚úÖ getSession (storage) ‚Üí', storedData, storedErr);
        session = storedData.session;
      }

      // --- 4. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ session ‡πÉ‡∏´‡πâ‡πÇ‡∏¢‡∏á‡∏Å‡∏•‡∏±‡∏ö login ---
      if (!session) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö session ‡∏´‡∏•‡∏±‡∏á callback');
      }

      // (Optional) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Å‡∏≤‡∏£ Login
      await fetch('https://pcsdata.onrender.com/api/log-action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: session.user.id,
          action: 'LOGIN_SUCCESS'
        })
      }).catch(console.warn);

      // --- 5. ‡∏°‡∏µ session ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏õ tors.html ---
      window.location.replace('/tors.html');
    } catch (err) {
      console.error('‚ùå Auth callback failed:', err);
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ login.html
      window.location.replace('/login.html');
    }
  </script>
</body>
</html>
