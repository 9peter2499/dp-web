<!DOCTYPE html>
<html>
<head>
    <title>Authenticating...</title>
</head>
<body>
    <p>กำลังตรวจสอบสถานะการล็อคอิน, กรุณารอสักครู่...</p>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/umd/supabase.umd.min.js"></script>

    <script type="module">
    import { createClient } 
      from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/+esm';

    // 1. ตั้งค่า Supabase client
    const SUPABASE_URL     = 'https://fhnprrlmlhleomfqqvpp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobnBycmxtbGhsZW9tZnFxdnBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTAyMjIsImV4cCI6MjA2NjQ4NjIyMn0.WA-_yNFWxpFnJBA3oh5UlOtq89KBm5hqsb51oi04hMk';
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    try {
      // 2. ดึง session จาก URL และเก็บให้อัตโนมัติ
      const { data: { session }, error: sessError } = 
        await supabaseClient.auth.getSessionFromUrl({ storeSession: true });
      if (sessError) throw sessError;
      if (!session) throw new Error('No session returned');

      // 3. (Optional) บันทึก Log การเข้าสู่ระบบ
      await fetch('https://pcsdata.onrender.com/api/log-action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: session.user.id,
          action: 'LOGIN_SUCCESS'
        })
      });

      // 4. Redirect ไปที่หน้า tors.html
      window.location.href = 'https://dp-web-lyfe.onrender.com/tors.html';
    } catch (e) {
      console.error('Auth callback error:', e.message);
      // กรณี error ให้กลับไปหน้า login
      window.location.href = 'https://dp-web-lyfe.onrender.com/';
    }
  </script>
</body>
</html>