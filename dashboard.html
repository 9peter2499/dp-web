<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ภาพรวมสถานะโครงการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">ภาพรวมสถานะการนำเสนอ Detail Design โครงการ Port Community System (PCS)</h1>
        <p id="last-updated" class="text-center text-gray-600 text-md mb-8">ข้อมูลอัพเดท วันที่: กำลังโหลด...</p>
        
        <div class="mb-12 mt-8 flex justify-center">
            <div id="main-summary-chart-container" class="w-full max-w-lg p-6 bg-white rounded-xl shadow-lg">
                <canvas id="main-summary-chart"></canvas>
            </div>
        </div>

        <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
            <!-- Cards will be injected here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            Chart.register(ChartDataLabels);
            
            try {
                const response = await fetch('https://pcsdata.onrender.com/api/summary');
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลสรุปได้');
                const cardData = await response.json();

                renderMainChart(cardData);
                renderCards(cardData);

                // ตั้งค่าวันที่อัปเดต
                document.getElementById('last-updated').textContent = `ข้อมูลอัพเดท วันที่ : ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            } catch (error) {
                console.error("Error fetching summary data:", error);
                document.getElementById('card-grid').innerHTML = `<p class="text-red-500 text-center col-span-full">${error.message}</p>`;
            }
        });

        function renderMainChart(data) {
            const mainCtx = document.getElementById('main-summary-chart').getContext('2d');
            
            const totalStats = data.reduce((acc, card) => {
                acc.pass += card.stats.pass;
                acc.fixed_pending_review += card.stats.fixed_pending_review;
                acc.needs_guidance += card.stats.needs_guidance;
                return acc;
            }, { pass: 0, fixed_pending_review: 0, needs_guidance: 0 });

            const grandTotal = totalStats.pass + totalStats.fixed_pending_review + totalStats.needs_guidance;

            new Chart(mainCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ผ่าน', 'ไม่ผ่าน (รอพิจารณา)', 'ไม่ผ่าน (ต้องการคำแนะนำ)'],
                    datasets: [{
                        data: [totalStats.pass, totalStats.fixed_pending_review, totalStats.needs_guidance],
                        backgroundColor: ['#22c55e', '#facc15', '#ef4444'],
                        borderColor: '#ffffff',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, font: { size: 14 } } },
                        title: { display: true, text: `ภาพรวมสถานะทั้งหมด: ${grandTotal} ข้อ`, font: { size: 18, weight: 'bold' }, padding: { bottom: 20 } },
                        datalabels: {
                            formatter: (value, ctx) => {
                                if (value === 0) return '';
                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100).toFixed(1);
                                return `${value}\n(${percentage}%)`;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 16 },
                            textAlign: 'center'
                        }
                    }
                }
            });
        }

        function renderCards(data) {
            const container = document.getElementById('card-grid');
            container.innerHTML = ''; // Clear loading state

            data.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 flex flex-col';
                
                const stats = card.stats;
                const totalItems = stats.pass + stats.fixed_pending_review + stats.needs_guidance;
                
                cardElement.innerHTML = `
                    <div class="bg-gray-50 p-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <a href="#" class="hover:underline">${card.title}</a>
                        </h2>
                    </div>
                    <div class="p-4 flex flex-col items-center gap-y-8">
                        <div class="w-full max-w-xs">
                            <canvas id="pie-chart-${index}"></canvas>
                        </div>
                    </div>
                `;
                container.appendChild(cardElement);

                const pieCtx = document.getElementById(`pie-chart-${index}`).getContext('2d');
                new Chart(pieCtx, {
                    type: 'doughnut', 
                    data: {
                        labels: ['ผ่าน', 'ไม่ผ่าน (รอพิจารณา)', 'ไม่ผ่าน (ต้องการคำแนะนำ)'],
                        datasets: [{
                            data: [stats.pass, stats.fixed_pending_review, stats.needs_guidance],
                            backgroundColor: ['#22c55e', '#facc15', '#ef4444'],
                            borderColor: ['#ffffff'],
                            borderWidth: 3
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: `จำนวนข้อกำหนดทั้งหมด ${totalItems}` },
                            datalabels: {
                                formatter: (value) => value > 0 ? value : '',
                                color: '#fff',
                                font: { weight: 'bold', size: 12 },
                            }
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>